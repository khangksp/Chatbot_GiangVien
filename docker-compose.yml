version: '3.8'

services:
  # =================================================================
  # 1. AI ENGINE (OLLAMA) - Ch·∫°y tr·ª±c ti·∫øp trong Docker
  # =================================================================
  ollama:
    image: ollama/ollama:latest
    container_name: bdu_chatbot_ollama
    volumes:
      - ollama_data:/root/.ollama # üíæ L∆∞u model vƒ©nh vi·ªÖn
    ports:
      - "11434:11434" # M·ªü port ƒë·ªÉ debug ho·∫∑c pull model th·ªß c√¥ng
    networks:
      - chatbot_network
    restart: always
    # ‚ö° C·∫§U H√åNH GPU (N·∫øu server c√≥ GPU NVIDIA & NVIDIA Container Toolkit)
    # N·∫øu server ch·ªâ c√≥ CPU, h√£y x√≥a ho·∫∑c comment ƒëo·∫°n 'deploy' n√†y.
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]

  # =================================================================
  # 2. H·ªÜ TH·ªêNG GI·∫¢NG VI√äN (GV) - Port 8019
  # =================================================================
  db_gv:
    image: postgres:15
    container_name: chatbot_db_gv
    volumes:
      - postgres_data_gv:/var/lib/postgresql/data
    environment:
      - POSTGRES_DB=bdu_chatbot_gv
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres123
    ports:
      - "5432:5432"
    restart: always
    networks:
      - chatbot_network

  chatbot_gv:
    build:
      context: ./chatbotGV/backend
      # üëá FIX: Dockerfile n·∫±m ngay trong context (chatbotGV/backend), kh√¥ng c·∫ßn l√πi ra ngo√†i
      dockerfile: Dockerfile 
    container_name: chatbot_be_gv
    volumes:
      - ./chatbotGV/backend:/app
      - media_volume_gv:/app/media
      - static_volume_gv:/app/staticfiles
      - hf_cache:/app/ai_models_cache
    ports:
      - "8019:3019"
    env_file:
      - ./chatbotGV/backend/.env
    environment:
      - DB_HOST=db_gv 
      - DATABASE_URL=postgresql://postgres:postgres123@db_gv:5432/bdu_chatbot_gv
      - DJANGO_SETTINGS_MODULE=backend.settings
      # üëá K·∫øt n·ªëi v·ªõi container 'ollama' qua m·∫°ng n·ªôi b·ªô
      - OLLAMA_API_URL=http://ollama:11434
      # C·∫•u h√¨nh OCR cho Linux
      - TESSERACT_PATH_RELATIVE=/usr/bin/tesseract
      - POPPLER_PATH_RELATIVE=/usr/bin
      - ALLOWED_HOSTS=*
      - CSRF_TRUSTED_ORIGINS=https://cds.bdu.edu.vn

    depends_on:
      - db_gv
      - ollama
    restart: always
    networks:
      - chatbot_network

  # =================================================================
  # 3. H·ªÜ TH·ªêNG SINH VI√äN (STUDENT) - Port 8020
  # =================================================================
  db_student:
    image: postgres:15
    container_name: chatbot_db_student
    volumes:
      - postgres_data_student:/var/lib/postgresql/data
    environment:
      - POSTGRES_DB=bdu_chatbot_student
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres123
    ports:
      - "5433:5432" # Port 5433 ƒë·ªÉ tr√°nh tr√πng
    restart: always
    networks:
      - chatbot_network

  chatbot_student:
    build:
      context: ./ChatBotStudent/backend
      # üëá FIX: T∆∞∆°ng t·ª± cho Student
      dockerfile: Dockerfile
    container_name: chatbot_be_student
    volumes:
      - ./ChatBotStudent/backend:/app
      - media_volume_student:/app/media
      - static_volume_student:/app/staticfiles
      - hf_cache:/app/ai_models_cache
    ports:
      - "8020:3019"
    env_file:
      - ./ChatBotStudent/backend/.env
    environment:
      - DB_HOST=db_student
      - DATABASE_URL=postgresql://postgres:postgres123@db_student:5432/bdu_chatbot_student
      - DJANGO_SETTINGS_MODULE=backend.settings
      - OLLAMA_API_URL=http://ollama:11434
      - TESSERACT_PATH_RELATIVE=/usr/bin/tesseract
      - POPPLER_PATH_RELATIVE=/usr/bin
    depends_on:
      - db_student
      - ollama
    restart: always
    networks:
      - chatbot_network

volumes:
  ollama_data:
  postgres_data_gv:
  static_volume_gv:
  media_volume_gv:
  postgres_data_student:
  static_volume_student:
  media_volume_student:
  hf_cache:

networks:
  chatbot_network:
    driver: bridge