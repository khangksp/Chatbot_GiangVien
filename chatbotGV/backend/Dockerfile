FROM python:3.10-slim

# Thi·∫øt l·∫≠p bi·∫øn m√¥i tr∆∞·ªùng
ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1
ENV KMP_DUPLICATE_LIB_OK=TRUE
# Cache model AI ƒë·ªÉ kh√¥ng ph·∫£i t·∫£i l·∫°i m·ªói l·∫ßn build l·∫°i image
ENV TRANSFORMERS_CACHE=/app/ai_models_cache

WORKDIR /app

# 1. C√†i ƒë·∫∑t c√°c g√≥i h·ªá th·ªëng c·∫ßn thi·∫øt (System Dependencies)
RUN apt-get update \
    && apt-get install -y --no-install-recommends \
        postgresql-client \
        build-essential \
        libpq-dev \
        git \
        curl \
        ffmpeg \
        libsndfile1 \
        tesseract-ocr \
        tesseract-ocr-vie \
        poppler-utils \
    && rm -rf /var/lib/apt/lists/*

# 2. C√†i ƒë·∫∑t Python Dependencies
COPY requirements.txt .

# üõ†Ô∏è M·∫∏O: C√†i tr∆∞·ªõc c√°c g√≥i n·∫∑ng ƒë·ªÉ cache layer Docker t·ªëi ∆∞u
RUN pip install --no-cache-dir --upgrade pip setuptools wheel && \
    pip install "numpy<2.0.0" && \
    pip install --no-cache-dir torch==2.3.1 --index-url https://download.pytorch.org/whl/cpu && \
    pip install --no-cache-dir sentence-transformers==2.7.0 && \
    pip install --no-cache-dir -r requirements.txt

# 3. Copy to√†n b·ªô code v√†o container
COPY . .

# 4. T·∫°o th∆∞ m·ª•c c·∫ßn thi·∫øt v√† c·∫•p quy·ªÅn
RUN mkdir -p logs media staticfiles ai_models_cache && chmod 777 ai_models_cache

# 5. M·ªü port 3019 (c·ªïng n·ªôi b·ªô container)
EXPOSE 3019

# 6. Entrypoint Script
# Script n√†y s·∫Ω ch·∫°y m·ªói khi container kh·ªüi ƒë·ªông
RUN echo '#!/bin/bash\n\
set -e\n\
echo "=== BDU ChatBot Docker Setup ==="\n\
\n\
echo "‚è≥ Waiting for Database ($DB_HOST)..."\n\
while ! pg_isready -h $DB_HOST -p 5432 -U postgres; do sleep 1; done\n\
echo "‚úÖ Database connected!"\n\
\n\
echo "üìä Running database migrations..."\n\
python manage.py migrate --noinput\n\
\n\
echo "üì¶ Collecting static files (WhiteNoise)..."\n\
python manage.py collectstatic --noinput\n\
\n\
echo "üë§ Setting up SuperAdmin user..."\n\
python manage.py shell -c "\n\
from django.contrib.auth import get_user_model; \n\
User = get_user_model();\n\
try:\n\
    # Ki·ªÉm tra xem user admin ƒë√£ t·ªìn t·∫°i ch∆∞a\n\
    if not User.objects.filter(username='\''admin'\'').exists():\n\
        print('\''Creating new admin user...'\'');\n\
        u = User.objects.create_superuser('\''admin'\'', '\''admin@bdu.edu.vn'\'', '\''Fira@2024'\'');\n\
        # üëá QUAN TR·ªåNG: G√°n faculty_code ƒë·ªÉ v∆∞·ª£t qua Custom Auth\n\
        u.faculty_code = '\''admin'\'';\n\
        u.full_name = '\''Administrator'\'';\n\
        u.is_staff = True;\n\
        u.is_superuser = True;\n\
        u.save();\n\
        print('\''‚úÖ Admin user created: admin / Fira@2024'\'');\n\
    else:\n\
        # N·∫øu ƒë√£ t·ªìn t·∫°i, ƒë·∫£m b·∫£o faculty_code ƒë√∫ng\n\
        print('\''‚ÑπÔ∏è Admin user already exists. Checking faculty_code...'\'');\n\
        u = User.objects.get(username='\''admin'\'');\n\
        if u.faculty_code != '\''admin'\'':\n\
            u.faculty_code = '\''admin'\'';\n\
            u.save();\n\
            print('\''üîß Fixed faculty_code for existing admin'\'');\n\
except Exception as e:\n\
    print(f'\''‚ùå Failed to create/update admin: {e}'\'')\n\
" \n\
\n\
echo "üöÄ Starting Django server on 0.0.0.0:3019..."\n\
python manage.py runserver 0.0.0.0:3019\n' > /entrypoint.sh

# C·∫•p quy·ªÅn th·ª±c thi cho script
RUN chmod +x /entrypoint.sh

# Set l·ªánh ch·∫°y m·∫∑c ƒë·ªãnh
CMD ["/entrypoint.sh"]