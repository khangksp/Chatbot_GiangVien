{% extends "admin/base_site.html" %}
{% load i18n admin_urls static admin_modify %}

{% block title %}Bulk Import t·ª´ CSV | Django Admin{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
    <a href="{% url 'admin:index' %}">Trang ch·ªß</a>
    &rsaquo; <a href="{% url 'admin:qa_management_qaentry_changelist' %}">Q&A Entries</a>
    &rsaquo; Bulk Import t·ª´ CSV
</div>
{% endblock %}

{% block extrahead %}
<style>
.upload-area {
    border: 2px dashed #ccc;
    border-radius: 8px;
    padding: 40px;
    text-align: center;
    background: #f9f9f9;
    margin: 20px 0;
    transition: all 0.3s ease;
}

.upload-area.dragover {
    border-color: #007bff;
    background: #e3f2fd;
}

.file-info {
    margin: 15px 0;
    padding: 10px;
    background: #e8f4fd;
    border-radius: 4px;
    display: none;
}

.format-example {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    padding: 15px;
    margin: 20px 0;
    font-family: monospace;
    overflow-x: auto;
}

.requirements {
    background: #fff3cd;
    border-left: 4px solid #ffc107;
    padding: 15px;
    margin: 20px 0;
}

.requirements ul {
    margin: 10px 0;
    padding-left: 20px;
}

.preview-table {
    width: 100%;
    border-collapse: collapse;
    margin: 20px 0;
    display: none;
}

.preview-table th,
.preview-table td {
    border: 1px solid #ddd;
    padding: 8px;
    text-align: left;
}

.preview-table th {
    background: #f8f9fa;
    font-weight: bold;
}
</style>
{% endblock %}

{% block content %}
<div class="module aligned" style="max-width: 900px;">
    <h1>üìä Bulk Import Q&A t·ª´ CSV</h1>
    
    <div class="requirements">
        <h3 style="margin-top: 0;">üìã Y√™u c·∫ßu ƒë·ªãnh d·∫°ng CSV</h3>
        <ul>
            <li><strong>Encoding:</strong> UTF-8</li>
            <li><strong>Header:</strong> STT, question, answer (b·∫Øt bu·ªôc)</li>
            <li><strong>STT:</strong> Ph·∫£i unique, ƒë·ªãnh d·∫°ng: TB_1252, QA_001, etc.</li>
            <li><strong>Question:</strong> Kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng</li>
            <li><strong>Answer:</strong> Kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng</li>
            <li><strong>Category:</strong> T·ª± ƒë·ªông set th√†nh "Gi·∫£ng vi√™n" n·∫øu kh√¥ng c√≥</li>
        </ul>
    </div>
    
    <div class="format-example">
        <h3>üí° V√≠ d·ª• ƒë·ªãnh d·∫°ng CSV:</h3>
        <pre>STT,question,answer,,
TB_1252,"Ng√¢n h√†ng ƒë·ªÅ thi l√† g√¨?","Ng√¢n h√†ng ƒë·ªÅ thi l√†...",,
TB_1253,"L√†m sao ƒë·ªÉ n·ªôp b√°o c√°o?","B·∫°n c·∫ßn g·ª≠i file v·ªÅ...",,
QA_001,"Th·ªùi h·∫°n n·ªôp l√† khi n√†o?","Th·ªùi h·∫°n n·ªôp l√†...",,</pre>
        <p style="color: #666; font-size: 0.9em; margin-top: 10px;">
            * C·ªôt 4 v√† 5 c√≥ th·ªÉ ƒë·ªÉ tr·ªëng (ƒë·ªÉ t∆∞∆°ng th√≠ch v·ªõi format Google Drive)
        </p>
    </div>
    
    <form method="post" enctype="multipart/form-data" id="upload-form">
        {% csrf_token %}
        
        <div class="form-row">
            <h2>üìÅ Ch·ªçn file CSV</h2>
            
            <div class="upload-area" id="upload-area">
                <div id="upload-prompt">
                    <h3 style="color: #666; margin: 10px 0;">üóÇÔ∏è K√©o th·∫£ file CSV v√†o ƒë√¢y</h3>
                    <p style="color: #999;">ho·∫∑c click ƒë·ªÉ ch·ªçn file</p>
                    <input type="file" name="csv_file" id="csv_file" accept=".csv" style="display: none;" required>
                    <button type="button" onclick="document.getElementById('csv_file').click()" class="button default">
                        Ch·ªçn File CSV
                    </button>
                </div>
                
                <div class="file-info" id="file-info">
                    <h4 id="file-name"></h4>
                    <p id="file-details"></p>
                </div>
            </div>
        </div>
        
        <div class="form-row" id="preview-section" style="display: none;">
            <h2>üëÄ Preview d·ªØ li·ªáu</h2>
            <table class="preview-table" id="preview-table">
                <thead>
                    <tr>
                        <th>STT</th>
                        <th>Question</th>
                        <th>Answer</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="preview-tbody">
                </tbody>
            </table>
            <div id="preview-summary"></div>
        </div>
        
        <div class="form-row">
            <h2>‚öôÔ∏è T√πy ch·ªçn Import</h2>
            
            <div style="margin: 15px 0;">
                <label>
                    <input type="checkbox" id="update_existing" checked>
                    C·∫≠p nh·∫≠t entries c√≥ c√πng STT (n·∫øu kh√¥ng check s·∫Ω skip entries tr√πng)
                </label>
            </div>
            
            <div style="margin: 15px 0;">
                <label>
                    <input type="checkbox" id="set_active" checked>
                    ƒê·∫∑t t·∫•t c·∫£ entries m·ªõi th√†nh active
                </label>
            </div>
            
            <div style="margin: 15px 0;">
                <label>
                    <input type="checkbox" id="validate_first" checked>
                    Validate d·ªØ li·ªáu tr∆∞·ªõc khi import (khuy·∫øn ngh·ªã)
                </label>
            </div>
        </div>
        
        <div class="submit-row">
            <input type="submit" value="üöÄ B·∫Øt ƒë·∫ßu Import" class="default" id="submit-btn" disabled>
            <a href="{% url 'admin:qa_management_qaentry_changelist' %}" class="button cancel-link">
                H·ªßy b·ªè
            </a>
        </div>
    </form>
    
    <div class="form-row" style="margin-top: 30px; padding: 15px; background: #d4edda; border-left: 4px solid #28a745;">
        <h3 style="color: #155724; margin-top: 0;">üí° Tips</h3>
        <ul style="margin: 0; color: #155724;">
            <li>Test v·ªõi file nh·ªè tr∆∞·ªõc khi import file l·ªõn</li>
            <li>Backup d·ªØ li·ªáu hi·ªán t·∫°i tr∆∞·ªõc khi import</li>
            <li>Check log ƒë·ªÉ xem chi ti·∫øt c√°c l·ªói n·∫øu c√≥</li>
            <li>Sau import, nh·ªõ sync l√™n Google Drive</li>
            <li>Rebuild FAISS index ƒë·ªÉ c·∫≠p nh·∫≠t chatbot</li>
        </ul>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const uploadArea = document.getElementById('upload-area');
    const fileInput = document.getElementById('csv_file');
    const fileInfo = document.getElementById('file-info');
    const uploadPrompt = document.getElementById('upload-prompt');
    const submitBtn = document.getElementById('submit-btn');
    const previewSection = document.getElementById('preview-section');
    const previewTable = document.getElementById('preview-table');
    const previewTbody = document.getElementById('preview-tbody');
    const previewSummary = document.getElementById('preview-summary');
    
    // Drag and drop handlers
    uploadArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        uploadArea.classList.add('dragover');
    });
    
    uploadArea.addEventListener('dragleave', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
    });
    
    uploadArea.addEventListener('drop', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            fileInput.files = files;
            handleFileSelect(files[0]);
        }
    });
    
    // File input change handler
    fileInput.addEventListener('change', function(e) {
        if (e.target.files.length > 0) {
            handleFileSelect(e.target.files[0]);
        }
    });
    
    function handleFileSelect(file) {
        // Validate file type
        if (!file.name.toLowerCase().endsWith('.csv')) {
            alert('Vui l√≤ng ch·ªçn file CSV (.csv)');
            return;
        }
        
        // Show file info
        uploadPrompt.style.display = 'none';
        fileInfo.style.display = 'block';
        
        document.getElementById('file-name').textContent = file.name;
        document.getElementById('file-details').textContent = 
            `Size: ${(file.size / 1024).toFixed(1)} KB | Type: ${file.type || 'text/csv'}`;
        
        // Enable submit button
        submitBtn.disabled = false;
        
        // Preview file content
        previewFile(file);
    }
    
    function previewFile(file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const csv = e.target.result;
                const lines = csv.split('\n');
                
                if (lines.length < 2) {
                    throw new Error('File CSV kh√¥ng c√≥ d·ªØ li·ªáu');
                }
                
                // Parse header
                const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
                
                // Validate required columns
                const requiredCols = ['STT', 'question', 'answer'];
                const missingCols = requiredCols.filter(col => !headers.includes(col));
                
                if (missingCols.length > 0) {
                    throw new Error(`Missing required columns: ${missingCols.join(', ')}`);
                }
                
                // Parse first few rows for preview
                const previewRows = [];
                let validRows = 0;
                let errorRows = 0;
                
                for (let i = 1; i < Math.min(6, lines.length); i++) {
                    if (lines[i].trim()) {
                        const cols = parseCSVLine(lines[i]);
                        const stt = cols[0] || '';
                        const question = cols[1] || '';
                        const answer = cols[2] || '';
                        
                        let status = '‚úÖ Valid';
                        if (!stt.trim() || !question.trim() || !answer.trim()) {
                            status = '‚ùå Missing required fields';
                            errorRows++;
                        } else {
                            validRows++;
                        }
                        
                        previewRows.push({
                            stt: stt.substring(0, 20),
                            question: question.substring(0, 50) + (question.length > 50 ? '...' : ''),
                            answer: answer.substring(0, 50) + (answer.length > 50 ? '...' : ''),
                            status: status
                        });
                    }
                }
                
                // Show preview
                previewTbody.innerHTML = '';
                previewRows.forEach(row => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${escapeHtml(row.stt)}</td>
                        <td>${escapeHtml(row.question)}</td>
                        <td>${escapeHtml(row.answer)}</td>
                        <td>${row.status}</td>
                    `;
                    previewTbody.appendChild(tr);
                });
                
                previewSummary.innerHTML = `
                    <p><strong>Total rows:</strong> ${lines.length - 1} | 
                    <strong>Preview:</strong> ${previewRows.length} rows | 
                    <strong>Valid:</strong> ${validRows} | 
                    <strong>Errors:</strong> ${errorRows}</p>
                `;
                
                previewSection.style.display = 'block';
                previewTable.style.display = 'table';
                
            } catch (error) {
                alert(`Error parsing CSV: ${error.message}`);
                console.error('CSV parsing error:', error);
            }
        };
        
        reader.readAsText(file);
    }
    
    function parseCSVLine(line) {
        const result = [];
        let current = '';
        let inQuotes = false;
        
        for (let i = 0; i < line.length; i++) {
            const char = line[i];
            
            if (char === '"') {
                inQuotes = !inQuotes;
            } else if (char === ',' && !inQuotes) {
                result.push(current.trim());
                current = '';
            } else {
                current += char;
            }
        }
        
        result.push(current.trim());
        return result;
    }
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    // Form submission confirmation
    document.getElementById('upload-form').addEventListener('submit', function(e) {
        const confirmed = confirm(
            'B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën import file CSV n√†y?\n\n' +
            'Thao t√°c n√†y c√≥ th·ªÉ m·∫•t v√†i ph√∫t t√πy thu·ªôc v√†o k√≠ch th∆∞·ªõc file.'
        );
        
        if (!confirmed) {
            e.preventDefault();
        } else {
            // Show loading state
            submitBtn.value = '‚è≥ ƒêang import...';
            submitBtn.disabled = true;
        }
    });
});
</script>
{% endblock %}